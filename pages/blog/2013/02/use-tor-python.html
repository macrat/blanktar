今話題（？）のTorを使ってみる - Python編
2013-02-28 21:01
keywords: tor python socks SocksiPy

<aside>
	前回：<a href="/blog/2013/02/use-tor-gentoo">今話題（？）のTorを使ってみる - gentoo編</a><br>
	<br>
</aside>
<section>
	多分最終回、python編だよ。<br>
	pythonからプロキシを使い方法について。若干Torからは離れるかも。<br>
	<a href="/blog/2013/02/use-tor-gentoo">前回</a>セットアップした<b>Vidalia</b>をそのまま使うので、まだの方はセットアップしてください。<br>
	サンプルではループバックアドレスを使っていますが、普通にIP入れれば他ホスト上のTorを使えます。<br>
	勿論、そのホストが使用を許可していた場合だけだけどね。<br>
	<br>
</section>
<section>
	<h3>SocksiPyを入れる</h3>
	pythonは標準ではsocksをサポートしてないようなので、<a href="http://socksipy.sourceforge.net/" target="_blank">SocksiPy</a>というのを使います。<br>
	ダウンロードして、適当に展開してください。<br>
	インストールするのが面倒くさかったら、展開したフォルダで作業しちゃってください。<br>
	インストールしたい場合は<b>pythonのインストールディレクトリ/Lib/site-packages/</b>にコピーすると良いと思うよ。<br>
	<br>
	<pre class="code"><code>import socks</code></pre>
	が成功することを確認してください。<br>
	<br>
</section>
<section>
	<h3>wget的なものを実装してみる</h3>
	socksを使って、Tor越しに動作するwgetを実装してみます。<br>
	ていってもめんどいので、便利な機能はまったくないけどね。落としてくるだけ。<br>
	<pre class="code"><code>import socks
import urllib
import sys
import os

PROXY_ADDR = '127.0.0.1'	# 使用するプロキシ(今回はTorが動いているホスト)のアドレス。IPアドレスじゃなくてwww.example.comみたいな形式でもおっけー。
PROXY_PORT = '9050'	# そのまんま、プロキシのポート番号。


if len(sys.argv) > 1:
	socks.setdefaultproxy(socks.PROXY_TYPE_SOCKS5, PROXY_ADDR, PROXY_PORT)	# デフォルトのプロキシを設定する

	urllib.socket.socket = socks.socksocket	# urllibのソケットを置き換える。これでurllibがsocksを使ってくれるようになる

	data = urllib.urlopen(sys.argv[1]).read()	# 上でソケットを置き換えたので、あとは普通にurllibを使える

	open(os.basename(sys.argv[1]), 'w').write(data)	# あとはもらったデータを保存するだけ
</code></pre>
	以上、こんな感じ。<br>
	<b>urllib.socket.socket</b>を<b>socks.socksocket</b>でオーバーライドするのがミソかな。<br>
	このやり方は他のライブラリにも使える、ような気がする。<br>
	<br>
</section>
<section>
	<h3>Tor越しにTCP接続</h3>
	前回チラッと触れましたが、socksさんは万能です。TCP接続ならなんでもリレーしてくれます。<br>
	ただ、Tor越しだとデバッグが相当面倒だけどね・・・。<br>
	<br>
	デバッグ用に簡単なコードを提示します。<br>
	提示しますが、私はこれを使いませんでした。よって使えるかは知らん。<br>
	<pre class="code"><code>import socket
import SocketServer

PORT = 5555	# 番号に意味は無いのでなんでもおっけー


ssock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
ssock.bind(('0.0.0.0', PORT))
ssock.listen(1)

while True:
	sock, fromaddr =  ssock.accept()
	print 'connect from', fromaddr
	sock.close()
</code></pre>
	これで繋いできた相手がわかるはず。<br>
	<br>
	さて、それではいよいよTor越しに接続を試みるコードを書いてみます。<br>
	<pre class="code"><code>import socks

PROXY_ADDR = '127.0.0.1'	# Torが動いているホスト
PROXY_PORT = 9050	# Torが動いているポート

HOST_ADDR = '000.123.456.789'	# 接続先のIPアドレス。当然だけど、グローバルIPを使用してください。Tor越しなので。
HOST_PORT = 5555	# ポート番号は適当に。とりあえず上記のコードと合わせてあります


sock = socks.socksocket()	# ソケットを作成。引数なしでおっけー。だってTCPしかないんだもの。

sock.setproxy(socks.PROXY_TYPE_SOCKS5, PROXY_ADDR, PROXY_PORT)	# 使用するプロキシを設定。wgetの時に使ったsetdefaultproxyと同じ設定をソケット別にしている、って感じ。
# ちなみに、第一引数のプロキシタイプには
#   PROXY_TYPE_SOCK4
#   PROXY_TYPE_SOCK5
#   PROXY_TYPE_HTTP
# が使えるようです。
# Torはsocks5ね。

# ここから先は普通のソケットとして使える。

sock.connect((HOST_ADDR, HOST_PORT))

# このサンプルでは接続だけ。適当に書き足して試してみてください。

sock.close()
</code></pre>
	以上、こんな感じ。<br>
	簡単だよね。setproxyが挟まるだけ。<br>
	<br>
	ただデバッグがあんまり簡単でなくて、ポートを開けてやる必要が出てきます。<br>
	ポートの開け方は・・・ググれっ<br>
	セキュリティ上の問題もあるので、デバッグが終わったら必ずポートを閉じるようにしましょう。<br>
	<br>
	ま、そんな感じで試してみてください。<br>
	見知らぬIPアドレスから接続される、はずです。<br>
	<br>
</section>
<br>
<section>
	楽に使えるものだね、Torって。<br>
	簡単なのは嬉しい。嬉しいのだけれど、これをどう使えばいいのやら・・・。<br>
	匿名で通信出来るってのは凄いけど、セキュアな通信ってだけならsslとかsshとか使えばいいし・・・。<br>
	なんかこう、良いネタ無いかな？<br>
</section>
