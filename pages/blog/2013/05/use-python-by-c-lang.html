pythonのモジュールをC言語から使う
2013-05-07 23:48
keywords: python C言語 モジュール python/C

pythonで書かれたモジュールをC言語から使うってのを試してみた話。<br>
まあ、つまり、<a href="/blog/2013/01/use-c-library-by-python">前に書いたpython/C API</a>の逆のことね。<br>
正直使いどころはちょっとわからないけれど、まあいいじゃない。<br>
<br>
<section>
	<h2>準備する</h2>
	<b>Python.h</b>ってのをインクルードする必要があるので、その辺を準備します。<br>
	ていっても、pythonがインストールされてる環境ならすでに入っているはず。<br>
	<br>
	インクルードパスにpythonがインストールされているディレクトリにある<b>include</b>ってパスを追加。<br>
	それと、<b>libs/python27.lib</b>ってファイルを一緒にコンパイルしてやります。<br>
	環境/バージョンによってファイル名違うかもだけど、適当に。<br>
	<br>
	windows / Visual C++のclコマンド を使う場合は<br>
	<pre class="code">$ <kbd>cl *.c /I%PYTHON_DIR%\include %PYTHON_DIR%\libs\python27.lib</kbd></pre>
	みたいな感じで。<br>
	勿論、%PYTHON_DIR%ってやつはpythonのインストールディレクトリに置き換えてください。<br>
</section>
<section>
	<h2>動かしてみる</h2>
	<pre class="code"><code>#include &lt;Python.h&gt;

int main()
{
	Py_Initialize();

	PyRun_SimpleString("print 'hello, world!'");

	Py_Finalize();
	return 0;
}
</code></pre>
	こうすると、<br>
	<pre class="code">$ <kbd>python -c "print 'hello, world!'"</kbd></pre>
	ってしたのと同じになります。<br>
</section>
<section>
	<h2>pythonのコードをインポートして、関数を実行</h2>
	いよいよ本命、pythonで書いたモジュールを使ってみます。<br>
	エラー処理とか省いて書いてるので、そのへんは適当に追加してね。<br>
	<br>
	<pre class="code"><code>#include &lt;stdio.h&gt;
#include &lt;Python.h&gt;

int main()
{
	PyObject *pModule, *pTmp;
	char *sTmp;

	Py_Initialize();

	/* モジュールをimport */
	pModule = PyImport_ImportModule("script");

	/* pythonで言う pTmp = getattr(pModule, 'func')() みたいな。 */
	pTmp = PyObject_CallMethod(pModule, "func", NULL);

	/* PyObjectをC言語の型に変換 */
	PyArg_Parse(pTmp, "s", &amp;sTmp)

	printf("%s\n", sTmp);

	Py_Finalize();
	return 0;
}
</code></pre>
	こんな感じ。<br>
	<br>
	python側のコードは<br>
	<pre class="code"><code>def func():
	print 'this printed by python'
	return 'byt, this printed by C'
</code></pre>
	みたいにしといてください。<br>
	コンパイルして実行してみると、pythonに書いた2つの文が両方表示されるはず。<br>
</section>
<br>
参考： <a href="http://docs.python.jp/2/c-api/veryhigh.html" target="_blank">超高レベルレイヤ - Python 2.7ja1 documentation</a><br>
