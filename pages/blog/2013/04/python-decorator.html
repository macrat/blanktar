pythonのデコレータを使ってお手軽ベンチマーク
2013-04-16 14:26
keywords: python デコレータ ベンチマーク

pythonにはデコレータというよく分からないものがありまして。<br>
よく分からないので込み入った解説はしないけれど、ともかく関数をデコレーションするもののようです。<br>
<br>
使い方は簡単　・・・かは分からないけれど、まあそれなりに。
<pre class="code"><code>import time
import functools

def Timer(func):
	@functools.wraps(func)
	def Wrapper(*args, **kw):
		stime = time.clock()
		ret = func(*args, **kw)
		etime = time.clock()
		print '{0}: {1:,f}ms'.format(func.__name__, (etime-stime)*1000)
		return ret
	return Wrapper

@Timer
def Test():
	print 'hello, decorator'

Test()
</code></pre>
こんな感じで使うと、Test関数の実行時間を測ってくれます。計測対象はいくつでもおっけー。<br>
計りたい関数の上に一行付け足すだけだから、お手軽でいいよね。<br>
ミリ秒単位で測ってる割に関数のオーバーヘッドを考慮してないから、あんまよろしくないですが。<br>
<br>
デコレーターに引数を付けたい時は<br>
<pre class="code"><code>import time
import functools

def Timer(name):
	def Deco(func):
		@functools.wraps(func)
		def Wrapper(*args, **kw):
			stime = time.clock()
			ret = func(*args, **kw)
			etime = time.clock()
			print '{0}: {1:,f}ms'.format(name, (etime-stime)*1000)
			return ret
		return Wrapper
	return Deco

@Timer('decorator test')
def Test():
	print 'hello, decorator'

Test()
</code></pre>
なんてやればおっけー。<br>
三重のdefとかあんまり使いたくないけどね・・・見づらい・・・。<br>
<br>
ちなみに、内部的には<br>
<pre class="code"><code>def Deco(func):
	def Wrapper(*args, **kw):
		print func.__name__
		return func(*args, **kw)
	return Wrapper

def Test():
	print 'a'
Test = Deco(Test)
</code></pre>
ってやるのと同義みたいね。<br>
引数付きの場合は<br>
<pre class="code"><code>Test = Deco(u'引数')(Test)</code></pre>
ということになるみたい。<br>
<br>
じゃあ<code>@functools.wraps(func)</code>は何かって？　それが分からんのだよ。<br>
省略すると、複数の関数をデコレーションした時におかしくなるんだけどね。後はよく分からん。<br>
