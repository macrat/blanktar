pythonのモジュールをCで書く
2013-01-30 13:28
keywords: python C言語 モジュール python/C ctypes

<b>追記:</b> この記事とは真逆の事をする記事も書きました。 <a href="/blog/2013/05/use-python-by-c-lang.html">pythonのモジュールをC言語から使う</a><br>
<br>
<br>
pythonは楽だ。難しいこと考えずに書けて、難しいこと考えずともどこでも動く。<br>
でもね、遅いんだ。速度が出ないんだ。<br>
C言語は速い。馬鹿みたいに速い。とりあえず大体速いし、最適化もしやすい。<br>
でもね、面倒なんだ。色々自分で考えなきゃいけないんだ。<br>
<br>
なら組み合わせて使えば良いんじゃね？　と言う訳で。<br>
試しにベンチマークしてみましたよ。<br>
使ったコードは<a href="/blog/2013/01/conpy.tar.gz">これ</a>ね。<br>
<br>
結果はこんな感じ。<br>
<pre class="code"><samp>-----階乗計算-----
20の階乗を一万回計算してみる
python: 0.144444775581 秒くらい
pythonAPI: 0.00294818878174 秒くらい
ctypes: 0.00294799804687 秒くらい

-----Adler32-----
アルファベットのAdler32を一万回計算してみる
python: 0.382977795601 秒くらい
pythonAPI: 0.00905439853668 秒くらい
ctypes: 0.00903975963593 秒くらい
</samp></pre>
速いねー、C速いねー。<br>
<br>
今回使ってみたのは二通りの方法。<br>
一つめがPython.hをインクルードしてCを書く方法。Python/C APIってやつ。<br>
モジュールを作るならこれが標準っぽい。書くのが面倒だけど、その分例外処理とかpythonの形を考慮するとか、まあ色々できるんだろうね。<br>
二つめがctypesモジュールを使ってpython側で何とかする方法。普通のCのライブラリを使えるっぽい。<br>
Cのソースは普通のCなので、とっても楽ちん。ただ、例外処理とかがよく分からない。<br>
引数間違えたらエラー出さずにフリーズしちゃったしね。結構怖いかも分からん。<br>
<br>
あら手軽、素敵だわ。って事で、今回はctypesの方をご紹介。<br>
手軽なのはいい事だね。コードなんて短くてなんぼです。<br>
試した限りPython/C APIとの速度差もほとんどなさげだしね。<br>
<br>
<b>1.普通にC言語でコードを書きます。</b><br>
単体のプログラムじゃないから、main関数は無し。<br>
<b>2.コンパイルします。</b><br>
gccなら<code class="code">gcc -shared -fPIC -o モジュール名.so ソースコードの名前</code>で。<br>
<b>3.pythonのctypesでロードします。</b><br>
<pre class="code"><code>import ctypes
test = ctypes.CDLL('./test.so')</code></pre>
みたいな感じ。モジュール名がtestの場合ね。<br>
<b>5.使います。</b><br>
後は普通にtest.func()みたいに使える。楽ちん。<br>
<br>
いやー、楽ちん楽ちん。<br>
上手いことやればかなりの高速化を期待できるはず。<br>
エラー処理がよく分からないので、その辺だけ注意で。<br>
<br>
まあ、これだけ手軽でもさ、そこまで速度が欲しいものって作らないのよね・・・。<br>
統計取りまくりとか、ゲーム作ってるとか、そういうんなら使えるんだろうけどさ。<br>
<br>
参考:<br>
<a href="http://www.hexacosa.net/documents/python-extending/" target="_blank">PythonのC言語拡張モジュール作成ガイド - hexacosa.net</a><br>
<a href="http://docs.python.jp/2.5/ext/ext.html" target="_blank">Python インタプリタの拡張と埋め込み - Pythonドキュメント</a><br>
