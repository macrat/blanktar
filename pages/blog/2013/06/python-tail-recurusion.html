Pythonで末尾再帰する
2013-06-08 19:16
keywords: python 末尾再帰 メタプログラミング

再帰っていいよね。なんか楽だ。<br>
楽なんだけど、メモリとか時間とか食うのよね。<br>
そこで末尾再帰・・・なんだけど、末尾再帰で書いても最適化されないんだよね、python。<br>
それならば、と最適化するのをデコレータで実装しちゃった人が居るらしい。<br>
メタプログラミングってやつだね。すごい。<br>
<br>
<a href="http://code.activestate.com/recipes/496691/" target="_blank">New Tail Recursion Decorator (Python recipe) - ActiveState Code</a><br>
<a href="http://d.hatena.ne.jp/tanihito/20110119/1295459297" target="_blank">Pythonのクロージャで末尾再帰最適化をする。 - tanihitoの日記</a><br>
<br>
だんだん綺麗になってくのがいいっすね、素敵。<br>
でもさ、まだ行けると思うんだ。<br>
という訳で、更に手を入れてみました。<br>
<pre class="code code_python"><code>def tail_recursive(func):
	from functools import wraps
	@wraps(func)
	def _tail(*args, **kwd):
		_tail.__args = args
		_tail.__kwd = kwd

		if _tail.__firstcall:
			_tail.__firstcall = False

			result = func
			try:
				while result is func:
					result = func(*_tail.__args, **_tail.__kwd)
			finally:
				_tail.__firstcall = True

			return result
		else:
			return func
	_tail.__firstcall = True

	return _tail
</code></pre>
関数のメンバ変数なんて変なものを使っているから、これはこれでなんか微妙だけどね。<br>
ま、それでもかなりシンプルになっている、はず。<br>
<br>
ちなみに、これを使ってもほとんど速度は向上しません。<br>
ま、関数呼び出しの回数は変わってないどころか増えてるから、仕方ないね。<br>
メモリ消費量は減る、かな？<br>
そんな事より大事なのは、再帰回数の制限を超えられること。<br>
何千回回そうとも止まらずに動いてくれる。素晴らしい。<br>
<br>
言語仕様そのものに組み込まれたりすると、処理速度も向上したりするんだろうけれどねー。<br>
どうっすか、偉い人？<br>
